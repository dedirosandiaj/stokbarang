import{startTransition as E,getOwner as k,getListener as v,onCleanup as L,sharedConfig as y,createSignal as x,createMemo as B,$TRACK as I}from"solid-js";import{isServer as h,getRequestEvent as O}from"solid-js/web";import{a as K,h as j,r as H,t as U,m as X}from"./routing-CMRlbYJP.js";const q="Location",W=5e3,G=18e4;let b=new Map;h||setInterval(()=>{const e=Date.now();for(let[t,r]of b.entries())!r[4].count&&e-r[0]>G&&b.delete(t)},3e5);function R(){if(!h)return b;const e=O();if(!e)throw new Error("Cannot find cache context");return(e.router||(e.router={})).cache||(e.router.cache=new Map)}function N(e,t=!0){return E(()=>{const r=Date.now();M(e,o=>{t&&(o[0]=0),o[4][1](r)})})}function M(e,t){e&&!Array.isArray(e)&&(e=[e]);for(let r of b.keys())(e===void 0||D(r,e))&&t(b.get(r))}function P(e,t){e.GET&&(e=e.GET);const r=(...o)=>{const n=R(),a=j(),f=H(),A=k()?K():void 0,m=Date.now(),l=t+S(o);let s=n.get(l),p;if(h){const i=O();if(i){const u=(i.router||(i.router={})).dataOnly;if(u){const w=i&&(i.router.data||(i.router.data={}));if(w&&l in w)return w[l];if(Array.isArray(u)&&!D(l,u))return w[l]=void 0,Promise.resolve()}}}if(v()&&!h&&(p=!0,L(()=>s[4].count--)),s&&s[0]&&(h||a==="native"||s[4].count||Date.now()-s[0]<W)){p&&(s[4].count++,s[4][0]()),s[3]==="preload"&&a!=="preload"&&(s[0]=m);let i=s[1];return a!=="preload"&&(i="then"in s[1]?s[1].then(g(!1),g(!0)):g(!1)(s[1]),!h&&a==="navigate"&&E(()=>s[4][1](s[0]))),f&&"then"in i&&i.catch(()=>{}),i}let c;if(!h&&y.has&&y.has(l)?(c=y.load(l),delete globalThis._$HY.r[l]):c=e(...o),s?(s[0]=m,s[1]=c,s[3]=a,!h&&a==="navigate"&&E(()=>s[4][1](s[0]))):(n.set(l,s=[m,c,,a,x(m)]),s[4].count=0),p&&(s[4].count++,s[4][0]()),h){const i=O();if(i&&i.router.dataOnly)return i.router.data[l]=c}if(a!=="preload"&&(c="then"in c?c.then(g(!1),g(!0)):g(!1)(c)),f&&"then"in c&&c.catch(()=>{}),h&&y.context&&y.context.async&&!y.context.noHydrate){const i=O();(!i||!i.serverOnly)&&y.context.serialize(l,c)}return c;function g(i){return async u=>{if(u instanceof Response){const w=O();if(w)for(const[F,T]of u.headers)F=="set-cookie"?w.response.headers.append("set-cookie",T):w.response.headers.set(F,T);const C=u.headers.get(q);if(C!==null){A&&C.startsWith("/")?E(()=>{A(C,{replace:!0})}):h?w&&(w.response.status=302):window.location.href=C;return}u.customBody&&(u=await u.customBody())}if(i)throw u;return s[2]=u,u}}};return r.keyFor=(...o)=>t+S(o),r.key=t,r}P.get=e=>R().get(e)[2];P.set=(e,t)=>{const r=R(),o=Date.now();let n=r.get(e);n?(n[0]=o,n[1]=Promise.resolve(t),n[2]=t,n[3]="preload"):(r.set(e,n=[o,Promise.resolve(t),t,"preload",x(o)]),n[4].count=0)};P.delete=e=>R().delete(e);P.clear=()=>R().clear();function D(e,t){for(let r of t)if(r&&e.startsWith(r))return!0;return!1}function S(e){return JSON.stringify(e,(t,r)=>z(r)?Object.keys(r).sort().reduce((o,n)=>(o[n]=r[n],o),{}):r)}function z(e){let t;return e!=null&&typeof e=="object"&&(!(t=Object.getPrototypeOf(e))||t===Object.prototype)}const _=new Map;function J(e,t){const r=U(),o=B(()=>r.submissions[0]().filter(n=>n.url===e.base&&!0));return new Proxy([],{get(n,a){return a===I?o():a==="pending"?o().some(f=>!f.result):o()[a]},has(n,a){return a in o()}})}function te(e,t){const r=J(e);return new Proxy({},{get(o,n){return r.length===0&&n==="clear"||n==="retry"?()=>{}:r[r.length-1]?.[n]}})}function re(e,t={}){function r(...a){const f=this.r,d=this.f,A=(f.singleFlight&&e.withOptions?e.withOptions({headers:{"X-Single-Flight":"true"}}):e)(...a),[m,l]=x();let s;function p(c){return async g=>{const i=await Q(g,c,f.navigatorFactory());let u=null;if(o.onComplete?.({...s,result:i?.data,error:i?.error,pending:!1,retry(){return u=s.retry()}}),u)return u;if(!i)return s.clear();if(l(i),i.error&&!d)throw i.error;return i.data}}return f.submissions[1](c=>[...c,s={input:a,url:n,get result(){return m()?.data},get error(){return m()?.error},get pending(){return!m()},clear(){f.submissions[1](g=>g.filter(i=>i!==s))},retry(){return l(void 0),e(...a).then(p(),p(!0))}}]),A.then(p(),p(!0))}const o=typeof t=="string"?{name:t}:t,n=e.url||o.name&&`https://action/${o.name}`||(h?"":`https://action/${Y(e.toString())}`);return r.base=n,$(r,n)}function $(e,t){return e.toString=()=>{if(!t)throw new Error("Client Actions need explicit names if server rendered");return t},e.with=function(...r){const o=function(...a){return e.call(this,...r,...a)};o.base=e.base;const n=new URL(t,X);return n.searchParams.set("args",S(r)),$(o,(n.origin==="https://action"?n.origin:"")+n.pathname+n.search)},e.url=t,h||(_.set(t,e),k()&&L(()=>_.delete(t))),e}const Y=e=>e.split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0)|0,0);async function Q(e,t,r){let o,n,a,f;if(e instanceof Response){if(e.headers.has("X-Revalidate")&&(a=e.headers.get("X-Revalidate").split(",")),e.customBody&&(o=n=await e.customBody(),e.headers.has("X-Single-Flight")&&(o=o._$value,delete n._$value,f=Object.keys(n))),e.headers.has("Location")){const d=e.headers.get("Location")||"/";d.startsWith("http")?window.location.href=d:r(d)}}else{if(t)return{error:e};o=e}return M(a,d=>d[0]=0),f&&f.forEach(d=>P.set(d,n[d])),await N(a,!1),o!=null?{data:o}:void 0}export{re as a,_ as b,te as u};
